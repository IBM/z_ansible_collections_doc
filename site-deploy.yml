################################################################################
# Copyright (c) IBM Corporation 2020, 2021
################################################################################

################################################################################
# Description:
#    This playbook will deploy the documentation that has been generated by
#    the playbook `site-builder.yml`. It will checkout the gh-pages submodule,
#    copy all the generated HTML, commit it with a static description and
#    push it to the repository assuming your ID has write permissions in this
#    repository and finally present the URL you can view the newly published
#    documentation.
# Usage:
#    ansible-playbook -i inventory site-deploy.yml
################################################################################

---
- hosts: all
  connection: local

- name: Partially tearing down to be save to avoid undesirable commits
  import_playbook: site-teardown.yml
  vars:
      set_make_clean: false

- hosts: all
  gather_facts: no
  connection: local

  tasks:
    ############################################################################
    # Copy the content generated by site-builder.yml` and perform the steps
    # to release and publish the content.
    ############################################################################
    - name: Copy the generated HTML from `build/html/` to `site/gh-pages/`
      shell: |
          cd site/gh-pages
          git checkout gh-pages
          cp -R ../../build/html/* .
          git add .
          git status
          git commit -m "Automated commit to update documentation"
          git push -f
          cd ../..
          git checkout master
          git status
          git submodule update
      register: git_update_doc

    - name: Display the HTML content uploaded to the doc site (gh-pages)
      debug: msg="{{ git_update_doc }}"

    ############################################################################
    # Display the URL to which one can view the newly published documentation.
    #    https://ibm.github.io/z_ansible_collections_doc/index.html
    ############################################################################

    - name: Follow this URL to view the updated collection content
      debug: msg="https://ibm.github.io/z_ansible_collections_doc/index.html"
